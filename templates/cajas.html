{% extends "base.html" %}
{% block title %}Cajas{% endblock %}
{% block content %}
<h2>Cajas</h2>
<div class="mb-3">
  <a href="{{ url_for('add_caja_route') }}" class="btn btn-success">Agregar Caja</a>
  <a href="{{ url_for('cargar_excel') }}" class="btn btn-primary"><i class="fas fa-file-excel"></i> Cargar desde Excel</a>
  <button id="exportar-seleccionados" class="btn btn-info"><i class="fas fa-file-export"></i> Exportar Seleccionados</button>
</div>

<div class="mb-4">
  <form action="{{ url_for('cajas') }}" method="GET" class="form-inline">
    <div class="input-group w-100">
      <input type="text" name="search" class="form-control" placeholder="Buscar por cualquier campo..." value="{{ search_term }}">
      <div class="input-group-append">
        <button class="btn btn-outline-primary" type="submit"><i class="fas fa-search"></i> Buscar</button>
        {% if search_term %}
          <a href="{{ url_for('cajas') }}" class="btn btn-outline-secondary"><i class="fas fa-times"></i> Limpiar</a>
        {% endif %}
      </div>
    </div>
  </form>
</div>
<form id="form-seleccion" action="{{ url_for('exportar_seleccionados') }}" method="POST">
<table class="table table-bordered table-striped">
  <thead>
    <tr>
      <th><input type="checkbox" id="seleccionar-todos"> Seleccionar</th>
      <th>ID</th>
      <th>ID Caja</th>
      <th>Departamento</th>
      <th>Años</th>
      <th>Tipo</th>
      <th>Observación</th>
      <th>Descripción</th>
      <th>Bodega</th>
      <th>Ubicación</th>
      <th>Percha</th>
      <th>Fila</th>
      <th>Columna</th>
      <th>QR</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for caja in cajas %}
    <tr>
      <td><input type="checkbox" name="cajas_seleccionadas" value="{{ caja.id }}" class="checkbox-caja"></td>
      <td>{{ caja.id }}</td>
      <td>{{ caja.id_caja }}</td>
      <td>{{ caja.departamento }}</td>
      <td>{{ caja.años }}</td>
      <td>{{ caja.tipo }}</td>
      <td>
        <div class="text-wrap" style="max-width: 150px; max-height: 80px; overflow-y: auto;">
          {{ caja.observacion }}
        </div>
      </td>
      <td>
        <div class="text-wrap" style="max-width: 200px; max-height: 100px; overflow-y: auto;">
          {{ caja.descripcion }}
        </div>
      </td>
      <td>{{ caja.bodega }}</td>
      <td>{{ caja.ubicacion }}</td>
      <td>{{ caja.percha }}</td>
      <td>{{ caja.fila }}</td>
      <td>{{ caja.columna }}</td>
      <td>
        <img src="{{ url_for('static', filename='qr_codes/' ~ caja.id_caja ~ '.png') }}" alt="QR" width="80">
      </td>
      <td>
        <a href="{{ url_for('edit_caja', caja_id=caja.id) }}" class="btn btn-primary btn-sm">Editar</a>
        <form action="{{ url_for('delete_caja_route', caja_id=caja.id) }}" method="POST" style="display:inline-block;" onsubmit="return confirm('¿Estás seguro de eliminar esta caja?');">
          <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Ejecutar cuando el DOM esté completamente cargado
  window.onload = function() {
    console.log('DOM cargado completamente');
    
    // Seleccionar todos los checkboxes
    const selectAllCheckbox = document.getElementById('seleccionar-todos');
    const cajaCheckboxes = document.querySelectorAll('.checkbox-caja');
    
    console.log('Checkbox principal:', selectAllCheckbox);
    console.log('Checkboxes de cajas encontrados:', cajaCheckboxes.length);
    
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('click', function() {
        console.log('Checkbox principal clickeado, estado:', this.checked);
        cajaCheckboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
      });
    }
    
    // Exportar seleccionados
    const exportarBtn = document.getElementById('exportar-seleccionados');
    console.log('Botón exportar:', exportarBtn);
    
    if (exportarBtn) {
      exportarBtn.addEventListener('click', function(e) {
        console.log('Botón exportar clickeado');
        e.preventDefault(); // Prevenir comportamiento por defecto del botón
        
        const seleccionados = document.querySelectorAll('.checkbox-caja:checked');
        console.log('Cajas seleccionadas:', seleccionados.length);
        
        if (seleccionados.length === 0) {
          alert('Por favor, seleccione al menos una caja para exportar.');
          return;
        }
        
        // Enviar el formulario
        const formulario = document.getElementById('form-seleccion');
        if (formulario) {
          console.log('Enviando formulario');
          formulario.submit();
        } else {
          console.error('Formulario no encontrado');
        }
      });
    }
  };
</script>
{% endblock %}
